{% extends 'base.html' %}

{% block title %}ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - ChemML{% endblock %}

{% block content %}
<h1 style="margin-bottom: 2rem;">ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>

<!-- æ¦‚è¦ãƒ¡ãƒˆãƒªã‚¯ã‚¹ -->
<div class="grid grid-4" style="margin-bottom: 2rem;">
    <div class="metric-card">
        <div class="metric-value" id="dataset-count">-</div>
        <div class="metric-label">ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ</div>
    </div>
    <div class="metric-card">
        <div class="metric-value" id="experiment-count">-</div>
        <div class="metric-label">å®Ÿé¨“</div>
    </div>
    <div class="metric-card">
        <div class="metric-value" id="completed-count">-</div>
        <div class="metric-label">å®Œäº†æ¸ˆã¿</div>
    </div>
    <div class="metric-card">
        <div class="metric-value" id="running-count">-</div>
        <div class="metric-label">å®Ÿè¡Œä¸­</div>
    </div>
</div>

<div class="grid grid-2">
    <!-- ã‚¯ã‚¤ãƒƒã‚¯äºˆæ¸¬ -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">ğŸ”® ã‚¯ã‚¤ãƒƒã‚¯äºˆæ¸¬</h2>
        </div>
        <form id="quick-predict-form">
            <div class="form-group">
                <label class="form-label">SMILES</label>
                <input type="text" class="form-control" id="smiles-input" placeholder="ä¾‹: CCO, c1ccccc1"
                    value="c1ccccc1">
            </div>
            <div class="form-group">
                <label class="form-label">å®Ÿé¨“ã‚’é¸æŠ</label>
                <select class="form-control" id="experiment-select">
                    <option value="">èª­ã¿è¾¼ã¿ä¸­...</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;">
                äºˆæ¸¬å®Ÿè¡Œ
            </button>
        </form>

        <div id="prediction-result" style="margin-top: 1rem; display: none;">
            <div class="grid grid-2">
                <div>
                    <h4 style="color: var(--text-muted);">äºˆæ¸¬å€¤</h4>
                    <div id="prediction-value" style="font-size: 2rem; font-weight: bold; color: var(--success);"></div>
                </div>
                <div class="mol-viewer" id="mol-viewer" style="min-height: 150px;"></div>
            </div>
        </div>
    </div>

    <!-- æœ€è¿‘ã®å®Ÿé¨“ -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">âš—ï¸ æœ€è¿‘ã®å®Ÿé¨“</h2>
            <a href="{% url 'experiments' %}" class="btn btn-sm btn-primary">ã™ã¹ã¦è¦‹ã‚‹</a>
        </div>
        <div id="recent-experiments">
            <div class="spinner" style="margin: 2rem auto;"></div>
        </div>
    </div>
</div>

<!-- åˆ†å­ç‰©æ€§ãƒ„ãƒ¼ãƒ« -->
<div class="card" style="margin-top: 1rem;">
    <div class="card-header">
        <h2 class="card-title">ğŸ“‹ åˆ†å­ç‰©æ€§è¨ˆç®—</h2>
    </div>
    <div class="grid grid-2">
        <div>
            <div class="form-group">
                <label class="form-label">SMILESå…¥åŠ›</label>
                <input type="text" class="form-control" id="props-smiles" placeholder="ä¾‹: CC(=O)Oc1ccccc1C(=O)O"
                    value="CC(=O)Oc1ccccc1C(=O)O">
            </div>
            <button onclick="calculateProperties()" class="btn btn-primary">è¨ˆç®—</button>
        </div>
        <div id="properties-result">
            <p style="color: var(--text-muted);">SMILESã‚’å…¥åŠ›ã—ã¦è¨ˆç®—ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    async function loadDashboard() {
        // ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆæ•°
        try {
            const datasets = await apiCall('/datasets');
            document.getElementById('dataset-count').textContent = datasets.length;
        } catch (e) {
            document.getElementById('dataset-count').textContent = '0';
        }

        // å®Ÿé¨“ä¸€è¦§
        try {
            const experiments = await apiCall('/experiments');
            document.getElementById('experiment-count').textContent = experiments.length;
            document.getElementById('completed-count').textContent =
                experiments.filter(e => e.status === 'COMPLETED').length;
            document.getElementById('running-count').textContent =
                experiments.filter(e => e.status === 'RUNNING').length;

            // å®Ÿé¨“ã‚»ãƒ¬ã‚¯ãƒˆ
            const select = document.getElementById('experiment-select');
            const completed = experiments.filter(e => e.status === 'COMPLETED');
            select.innerHTML = completed.length
                ? completed.map(e => `<option value="${e.id}">${e.name}</option>`).join('')
                : '<option value="">å®Œäº†ã—ãŸå®Ÿé¨“ãŒã‚ã‚Šã¾ã›ã‚“</option>';

            // æœ€è¿‘ã®å®Ÿé¨“
            const recent = document.getElementById('recent-experiments');
            recent.innerHTML = experiments.slice(0, 5).map(e => `
            <div style="display: flex; justify-content: space-between; align-items: center; 
                        padding: 0.75rem 0; border-bottom: 1px solid var(--border);">
                <div>
                    <strong>${e.name}</strong>
                    <div style="font-size: 0.875rem; color: var(--text-muted);">
                        ${new Date(e.created_at).toLocaleString('ja-JP')}
                    </div>
                </div>
                <span class="badge badge-${e.status === 'COMPLETED' ? 'success' :
                    e.status === 'RUNNING' ? 'warning' :
                        e.status === 'FAILED' ? 'error' : 'info'}">${e.status}</span>
            </div>
        `).join('') || '<p style="color: var(--text-muted);">å®Ÿé¨“ãŒã‚ã‚Šã¾ã›ã‚“</p>';
        } catch (e) {
            document.getElementById('experiment-count').textContent = '0';
            document.getElementById('completed-count').textContent = '0';
            document.getElementById('running-count').textContent = '0';
        }
    }

    // ã‚¯ã‚¤ãƒƒã‚¯äºˆæ¸¬
    document.getElementById('quick-predict-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const smiles = document.getElementById('smiles-input').value;
        const expId = document.getElementById('experiment-select').value;

        if (!expId) {
            showToast('å®Ÿé¨“ã‚’é¸æŠã—ã¦ãã ã•ã„', 'warning');
            return;
        }

        try {
            const result = await apiCall(`/experiments/${expId}/predict`, {
                method: 'POST',
                body: JSON.stringify({ smiles })
            });

            document.getElementById('prediction-value').textContent = result.prediction.toFixed(4);
            document.getElementById('prediction-result').style.display = 'block';
            showMolecule(smiles, 'mol-viewer');
            showToast('äºˆæ¸¬å®Œäº†!', 'success');
        } catch (e) {
            // Error handled in apiCall
        }
    });

    // ç‰©æ€§è¨ˆç®—
    async function calculateProperties() {
        const smiles = document.getElementById('props-smiles').value;
        const result = document.getElementById('properties-result');

        try {
            const props = await apiCall(`/molecules/${encodeURIComponent(smiles)}/properties`);
            result.innerHTML = `
            <table class="table" style="font-size: 0.9rem;">
                <tr><th>åˆ†å­é‡</th><td>${props.molecular_weight} g/mol</td></tr>
                <tr><th>LogP</th><td>${props.logp}</td></tr>
                <tr><th>TPSA</th><td>${props.tpsa} Ã…Â²</td></tr>
                <tr><th>æ°´ç´ çµåˆãƒ‰ãƒŠãƒ¼</th><td>${props.hbd}</td></tr>
                <tr><th>æ°´ç´ çµåˆã‚¢ã‚¯ã‚»ãƒ—ã‚¿ãƒ¼</th><td>${props.hba}</td></tr>
                <tr><th>å›è»¢å¯èƒ½çµåˆ</th><td>${props.rotatable_bonds}</td></tr>
                <tr><th>ç’°ã®æ•°</th><td>${props.num_rings}</td></tr>
                <tr><th>åŸå­æ•°</th><td>${props.num_atoms}</td></tr>
            </table>
        `;
        } catch (e) {
            result.innerHTML = '<p style="color: var(--error);">è¨ˆç®—ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
        }
    }

    // åˆæœŸåŒ–
    loadDashboard();
</script>
{% endblock %}
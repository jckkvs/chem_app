{% extends 'base.html' %}

{% block title %}äºˆæ¸¬ - ChemML{% endblock %}

{% block extra_css %}
<style>
    .prediction-result {
        background: var(--bg-hover);
        border-radius: 12px;
        padding: 2rem;
        text-align: center;
        margin-top: 1.5rem;
    }

    .prediction-value {
        font-size: 3rem;
        font-weight: bold;
        color: var(--success);
        margin: 1rem 0;
    }

    .confidence-bar {
        width: 100%;
        height: 8px;
        background: var(--border);
        border-radius: 4px;
        overflow: hidden;
        margin-top: 0.5rem;
    }

    .confidence-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary), var(--secondary));
        transition: width 0.3s;
    }
</style>
{% endblock %}

{% block content %}
<h1 style="margin-bottom: 2rem;">ğŸ”® åˆ†å­ç‰©æ€§äºˆæ¸¬</h1>

<div class="grid grid-2">
    <!-- äºˆæ¸¬ãƒ•ã‚©ãƒ¼ãƒ  -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">å…¥åŠ›</h2>
        </div>

        <form id="predict-form">
            <div class="form-group">
                <label class="form-label">å®Ÿé¨“ã‚’é¸æŠ</label>
                <select id="experiment-select" class="form-control" required>
                    <option value="">èª­ã¿è¾¼ã¿ä¸­...</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">SMILES</label>
                <textarea id="smiles-input" class="form-control" rows="4"
                    placeholder="1è¡Œã«1ã¤ã®SMILESã‚’å…¥åŠ›&#10;ä¾‹:&#10;CCO&#10;c1ccccc1&#10;CC(=O)O" required></textarea>
                <small style="color: var(--text-muted);">è¤‡æ•°ã®SMILESã‚’å…¥åŠ›ã™ã‚‹ã¨ãƒãƒƒãƒäºˆæ¸¬ã«ãªã‚Šã¾ã™</small>
            </div>

            <button type="submit" class="btn btn-primary" style="width: 100%;">
                ğŸš€ äºˆæ¸¬å®Ÿè¡Œ
            </button>
        </form>

        <!-- ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³çµæœ -->
        <div id="validation-result" style="margin-top: 1rem;"></div>
    </div>

    <!-- äºˆæ¸¬çµæœ -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">çµæœ</h2>
        </div>

        <div id="prediction-output">
            <p style="color: var(--text-muted); text-align: center; padding: 2rem;">
                å·¦å´ã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰äºˆæ¸¬ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„
            </p>
        </div>
    </div>
</div>

<!-- ãƒãƒƒãƒäºˆæ¸¬çµæœãƒ†ãƒ¼ãƒ–ãƒ« -->
<div id="batch-results" style="display: none; margin-top: 2rem;">
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">ãƒãƒƒãƒäºˆæ¸¬çµæœ</h2>
            <button onclick="downloadBatchResults()" class="btn btn-sm btn-primary">
                ğŸ“¥ CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            </button>
        </div>
        <div class="table-container" style="max-height: 500px; overflow-y: auto;">
            <table class="table" id="batch-table">
                <thead>
                    <tr>
                        <th>SMILES</th>
                        <th>äºˆæ¸¬å€¤</th>
                        <th>çŠ¶æ…‹</th>
                    </tr>
                </thead>
                <tbody id="batch-tbody"></tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let batchResultsData = [];

    // å®Ÿé¨“ä¸€è¦§èª­ã¿è¾¼ã¿
    async function loadExperiments() {
        const select = document.getElementById('experiment-select');
        try {
            const experiments = await apiCall('/experiments');
            const completed = experiments.filter(e => e.status === 'COMPLETED');

            select.innerHTML = completed.length
                ? completed.map(e => `<option value="${e.id}">${e.name} (${e.config?.model_type})</option>`).join('')
                : '<option value="">å®Œäº†ã—ãŸå®Ÿé¨“ãŒã‚ã‚Šã¾ã›ã‚“</option>';
        } catch (e) {
            select.innerHTML = '<option value="">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</option>';
        }
    }

    // SMILESãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    let validateTimeout;
    document.getElementById('smiles-input').addEventListener('input', (e) => {
        clearTimeout(validateTimeout);
        validateTimeout = setTimeout(async () => {
            const smiles = e.target.value.trim();
            if (!smiles) {
                document.getElementById('validation-result').innerHTML = '';
                return;
            }

            const lines = smiles.split('\n').filter(s => s.trim());
            const resultDiv = document.getElementById('validation-result');

            if (lines.length === 1) {
                // å˜ä¸€SMILESæ¤œè¨¼
                try {
                    const res = await apiCall(`/molecules/validate`, {
                        method: 'POST',
                        body: JSON.stringify({ smiles: lines[0] })
                    });

                    if (res.valid) {
                        resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            âœ… æœ‰åŠ¹ãªSMILES<br>
                            <small>æ­£è¦åŒ–: <code>${res.canonical_smiles}</code></small>
                        </div>
                    `;
                        // åˆ†å­æ§‹é€ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
                        showMoleculePreview(lines[0]);
                    } else {
                        resultDiv.innerHTML = `<div class="alert alert-error">âŒ ç„¡åŠ¹ãªSMILES</div>`;
                    }
                } catch (e) {
                    resultDiv.innerHTML = `<div class="alert alert-error">æ¤œè¨¼ã‚¨ãƒ©ãƒ¼</div>`;
                }
            } else {
                // ãƒãƒƒãƒãƒ¢ãƒ¼ãƒ‰
                resultDiv.innerHTML = `
                <div class="alert alert-warning">
                    ğŸ“¦ ãƒãƒƒãƒãƒ¢ãƒ¼ãƒ‰: ${lines.length}ä»¶ã®SMILESã‚’å‡¦ç†ã—ã¾ã™
                </div>
            `;
            }
        }, 500);
    });

    // åˆ†å­æ§‹é€ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
    function showMoleculePreview(smiles) {
        const output = document.getElementById('prediction-output');
        output.innerHTML = `
        <div class="mol-viewer" id="mol-preview" style="min-height: 200px;">
            <div class="spinner" style="margin: 2rem auto;"></div>
        </div>
    `;
        showMolecule(smiles, 'mol-preview');
    }

    // äºˆæ¸¬å®Ÿè¡Œ
    document.getElementById('predict-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const expId = document.getElementById('experiment-select').value;
        const smilesInput = document.getElementById('smiles-input').value.trim();

        if (!expId || !smilesInput) {
            showToast('å…¥åŠ›ã‚’ç¢ºèªã—ã¦ãã ã•ã„', 'warning');
            return;
        }

        const smilesList = smilesInput.split('\n').filter(s => s.trim());
        const output = document.getElementById('prediction-output');

        output.innerHTML = '<div class="spinner" style="margin: 2rem auto;"></div>';

        try {
            if (smilesList.length === 1) {
                // å˜ä¸€äºˆæ¸¬
                const result = await apiCall(`/experiments/${expId}/predict`, {
                    method: 'POST',
                    body: JSON.stringify({ smiles: smilesList[0] })
                });

                displaySingleResult(result, smilesList[0]);
            } else {
                // ãƒãƒƒãƒäºˆæ¸¬
                const result = await apiCall(`/experiments/${expId}/batch_predict`, {
                    method: 'POST',
                    body: JSON.stringify({ smiles_list: smilesList })
                });

                displayBatchResults(result.predictions);
            }

            showToast('äºˆæ¸¬å®Œäº†ï¼', 'success');
        } catch (e) {
            output.innerHTML = `<div class="alert alert-error">äºˆæ¸¬å¤±æ•—: ${e.message}</div>`;
        }
    });

    // å˜ä¸€äºˆæ¸¬çµæœè¡¨ç¤º
    function displaySingleResult(result, smiles) {
        const output = document.getElementById('prediction-output');
        const pred = result.prediction;

        output.innerHTML = `
        <div class="prediction-result">
            <div style="color: var(--text-muted);">äºˆæ¸¬å€¤</div>
            <div class="prediction-value">${pred.toFixed(4)}</div>
            
            ${result.confidence ? `
                <div style="margin-top: 1rem;">
                    <div style="color: var(--text-muted); font-size: 0.875rem;">ä¿¡é ¼åº¦</div>
                    <div class="confidence-bar">
                        <div class="confidence-fill" style="width: ${result.confidence * 100}%;"></div>
                    </div>
                    <div style="color: var(--text-muted); font-size: 0.875rem; margin-top: 0.25rem;">
                        ${(result.confidence * 100).toFixed(1)}%
                    </div>
                </div>
            ` : ''}
        </div>
        
        <div class="mol-viewer" id="result-mol" style="margin-top: 1rem; min-height: 200px;"></div>
    `;

        showMolecule(smiles, 'result-mol');
        document.getElementById('batch-results').style.display = 'none';
    }

    // ãƒãƒƒãƒäºˆæ¸¬çµæœè¡¨ç¤º
    function displayBatchResults(predictions) {
        batchResultsData = predictions;

        const tbody = document.getElementById('batch-tbody');
        tbody.innerHTML = predictions.map(p => `
        <tr>
            <td><code>${p.smiles}</code></td>
            <td style="font-weight: bold; color: var(--success);">${p.prediction ? p.prediction.toFixed(4) : '-'}</td>
            <td>${p.success ? '<span class="badge badge-success">æˆåŠŸ</span>' : '<span class="badge badge-error">å¤±æ•—</span>'}</td>
        </tr>
    `).join('');

        document.getElementById('batch-results').style.display = 'block';
        document.getElementById('prediction-output').innerHTML = `
        <div class="alert alert-success">
            âœ… ${predictions.filter(p => p.success).length} / ${predictions.length} ä»¶ã®äºˆæ¸¬ãŒæˆåŠŸã—ã¾ã—ãŸ
        </div>
    `;
    }

    // CSV ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    function downloadBatchResults() {
        const csv = 'SMILES,Prediction,Success\n' +
            batchResultsData.map(r => `${r.smiles},${r.prediction || ''},${r.success}`).join('\n');

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `predictions_${Date.now()}.csv`;
        a.click();
        URL.revokeObjectURL(url);
    }

    // åˆæœŸåŒ–
    loadExperiments();
</script>
{% endblock %}
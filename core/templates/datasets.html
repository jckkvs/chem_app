{% extends 'base.html' %}

{% block title %}ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆç®¡ç† - ChemML{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <h1>ğŸ“‚ ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆç®¡ç†</h1>
    <button onclick="showUploadModal()" class="btn btn-primary">
        â• æ–°è¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    </button>
</div>

<!-- ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ« -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆä¸€è¦§</h2>
    </div>
    <div id="datasets-table"></div>
</div>

<!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆå‹•çš„ç”Ÿæˆï¼‰ -->
{% endblock %}

{% block extra_js %}
<script>
    // ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ«
    const datasetsTable = new DataTable('datasets-table', [
        { label: 'ID', getValue: d => d.id },
        { label: 'åå‰', getValue: d => d.name },
        { label: 'ã‚µãƒ³ãƒ—ãƒ«æ•°', getValue: d => d.num_samples || '-' },
        { label: 'SMILESã‚«ãƒ©ãƒ ', getValue: d => d.smiles_col },
        { label: 'ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚«ãƒ©ãƒ ', getValue: d => d.target_col },
        {
            label: 'ä½œæˆæ—¥æ™‚',
            getValue: d => d.created_at,
            render: d => new Date(d.created_at).toLocaleString('ja-JP')
        },
        {
            label: 'ã‚¢ã‚¯ã‚·ãƒ§ãƒ³',
            getValue: () => '',
            render: d => `
            <button onclick="viewDataset(${d.id})" class="btn btn-sm" style="background: var(--bg-hover);">
                ğŸ‘ï¸ è¡¨ç¤º
            </button>
            <button onclick="deleteDataset(${d.id})" class="btn btn-sm btn-danger">
                ğŸ—‘ï¸ å‰Šé™¤
            </button>
        `
        }
    ], async () => {
        return await apiCall('/datasets');
    });

    datasetsTable.render();

    // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
    function showUploadModal() {
        const modal = new ModalDialog();
        modal.show('ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰', `
        <form id="upload-form" onsubmit="handleUpload(event)">
            <div class="form-group">
                <label class="form-label">ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆå</label>
                <input type="text" name="name" class="form-control" placeholder="ä¾‹: Solubility Dataset" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">CSVãƒ•ã‚¡ã‚¤ãƒ«</label>
                <div id="drop-zone" style="
                    border: 2px dashed var(--border);
                    border-radius: 8px;
                    padding: 2rem;
                    text-align: center;
                    cursor: pointer;
                    transition: all 0.3s;
                " onclick="document.getElementById('file-input').click()">
                    <p>ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—<br>ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</p>
                    <input type="file" id="file-input" name="file" accept=".csv" style="display: none;" required>
                </div>
                <div id="file-name" style="margin-top: 0.5rem; color: var(--text-muted);"></div>
            </div>
            
            <div class="grid grid-2">
                <div class="form-group">
                    <label class="form-label">SMILESã‚«ãƒ©ãƒ </label>
                    <input type="text" name="smiles_col" class="form-control" value="SMILES" required>
                </div>
                <div class="form-group">
                    <label class="form-label">ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚«ãƒ©ãƒ </label>
                    <input type="text" name="target_col" class="form-control" value="target" required>
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary" style="width: 100%;">
                ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            </button>
        </form>
    `);

        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—åˆæœŸåŒ–
        setTimeout(() => {
            const fileInput = document.getElementById('file-input');
            const fileName = document.getElementById('file-name');

            initFileUpload('drop-zone', 'file-input', (file) => {
                fileName.textContent = `é¸æŠ: ${file.name}`;
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length) {
                    fileName.textContent = `é¸æŠ: ${e.target.files[0].name}`;
                }
            });
        }, 100);
    }

    // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
    async function handleUpload(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);

        try {
            const res = await fetch(`${API_URL}/datasets`, {
                method: 'POST',
                body: formData
            });

            if (!res.ok) throw new Error('Upload failed');

            showToast('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸï¼', 'success');
            document.querySelector('.modal-overlay').remove();
            datasetsTable.render();
        } catch (e) {
            showToast('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—: ' + e.message, 'error');
        }
    }

    // ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆè¡¨ç¤º
    function viewDataset(id) {
        const modal = new ModalDialog();
        modal.show('ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆè©³ç´°', `
        <div class="spinner" style="margin: 2rem auto;"></div>
    `);

        fetch(`${API_URL}/datasets/${id}`)
            .then(res => res.json())
            .then(data => {
                const content = `
                <div class="grid grid-2" style="margin-bottom: 1rem;">
                    <div>
                        <strong>ID:</strong> ${data.id}<br>
                        <strong>åå‰:</strong> ${data.name}<br>
                        <strong>ã‚µãƒ³ãƒ—ãƒ«æ•°:</strong> ${data.num_samples || '-'}
                    </div>
                    <div>
                        <strong>SMILESã‚«ãƒ©ãƒ :</strong> ${data.smiles_col}<br>
                        <strong>ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚«ãƒ©ãƒ :</strong> ${data.target_col}<br>
                        <strong>ä½œæˆæ—¥æ™‚:</strong> ${new Date(data.created_at).toLocaleString('ja-JP')}
                    </div>
                </div>
                <div style="text-align: center;">
                    <a href="${data.file_path}" download class="btn btn-primary">
                        ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    </a>
                </div>
            `;
                document.querySelector('.modal-content div:last-child').innerHTML = content;
            })
            .catch(e => {
                document.querySelector('.modal-content div:last-child').innerHTML =
                    '<p style="color: var(--error);">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</p>';
            });
    }

    // ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆå‰Šé™¤
    async function deleteDataset(id) {
        if (!confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

        try {
            await apiCallWithCSRF(`/datasets/${id}`, { method: 'DELETE' });
            showToast('å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
            datasetsTable.render();
        } catch (e) {
            // Error handled in apiCallWithCSRF
        }
    }
</script>
{% endblock %}
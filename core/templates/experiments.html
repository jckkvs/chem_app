{% extends 'base.html' %}

{% block title %}å®Ÿé¨“ç®¡ç† - ChemML{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <h1>âš—ï¸ å®Ÿé¨“ç®¡ç†</h1>
    <button onclick="showCreateExperimentModal()" class="btn btn-primary">
        â• æ–°è¦å®Ÿé¨“
    </button>
</div>

<!-- å®Ÿé¨“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚µãƒãƒªãƒ¼ -->
<div class="grid grid-4" style="margin-bottom: 2rem;">
    <div class="metric-card" style="background: linear-gradient(135deg, #48bb78, #38a169);">
        <div class="metric-value" id="completed-exp">-</div>
        <div class="metric-label">å®Œäº†</div>
    </div>
    <div class="metric-card" style="background: linear-gradient(135deg, #ed8936, #dd6b20);">
        <div class="metric-value" id="running-exp">-</div>
        <div class="metric-label">å®Ÿè¡Œä¸­</div>
    </div>
    <div class="metric-card" style="background: linear-gradient(135deg, #f56565, #e53e3e);">
        <div class="metric-value" id="failed-exp">-</div>
        <div class="metric-label">å¤±æ•—</div>
    </div>
    <div class="metric-card" style="background: linear-gradient(135deg, #4299e1, #3182ce);">
        <div class="metric-value" id="pending-exp">-</div>
        <div class="metric-label">å¾…æ©Ÿä¸­</div>
    </div>
</div>

<!-- å®Ÿé¨“ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ« -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">å®Ÿé¨“ä¸€è¦§</h2>
        <button onclick="experimentsTable.render()" class="btn btn-sm" style="background: var(--bg-hover);">
            ğŸ”„ æ›´æ–°
        </button>
    </div>
    <div id="experiments-table"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // å®Ÿé¨“ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ«
    const experimentsTable = new DataTable('experiments-table', [
        { label: 'ID', getValue: e => e.id },
        { label: 'åå‰', getValue: e => e.name },
        {
            label: 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹',
            getValue: e => e.status,
            render: e => {
                const colors = {
                    'COMPLETED': 'success',
                    'RUNNING': 'warning',
                    'FAILED': 'error',
                    'PENDING': 'info'
                };
                return `<span class="badge badge-${colors[e.status] || 'info'}">${e.status}</span>`;
            }
        },
        { label: 'ãƒ¢ãƒ‡ãƒ«', getValue: e => e.config?.model_type || '-' },
        { label: 'ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—', getValue: e => e.config?.task_type_mode || '-' },
        {
            label: 'ä½œæˆæ—¥æ™‚',
            getValue: e => e.created_at,
            render: e => new Date(e.created_at).toLocaleString('ja-JP')
        },
        {
            label: 'ã‚¢ã‚¯ã‚·ãƒ§ãƒ³',
            getValue: () => '',
            render: e => `
            <button onclick="viewExperiment(${e.id})" class="btn btn-sm" style="background: var(--bg-hover);">
                ğŸ‘ï¸ è©³ç´°
            </button>
            ${e.status === 'COMPLETED' ? `
                <button onclick="downloadModel(${e.id})" class="btn btn-sm btn-primary">
                    ğŸ“¥ DL
                </button>
            ` : ''}
        `
        }
    ], async () => {
        const exps = await apiCall('/experiments');

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°
        document.getElementById('completed-exp').textContent = exps.filter(e => e.status === 'COMPLETED').length;
        document.getElementById('running-exp').textContent = exps.filter(e => e.status === 'RUNNING').length;
        document.getElementById('failed-exp').textContent = exps.filter(e => e.status === 'FAILED').length;
        document.getElementById('pending-exp').textContent = exps.filter(e => e.status === 'PENDING').length;

        return exps;
    });

    // åˆæœŸãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã¨ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
    experimentsTable.render();
    window.liveUpdater = new LiveUpdater(() => experimentsTable.render(), 10000);
    window.liveUpdater.start();

    // å®Ÿé¨“ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«
    async function showCreateExperimentModal() {
        const datasets = await apiCall('/datasets');

        const modal = new ModalDialog();
        modal.show('ğŸ§ª æ–°è¦å®Ÿé¨“ä½œæˆ', `
        <form id="create-exp-form" onsubmit="handleCreateExperiment(event)">
            <div class="form-group">
                <label class="form-label">å®Ÿé¨“å</label>
                <input type="text" name="name" class="form-control" placeholder="ä¾‹: LogP Prediction v1" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ</label>
                <select name="dataset_id" class="form-control" required>
                    ${datasets.map(d => `<option value="${d.id}">${d.name}</option>`).join('')}
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—</label>
                <select name="task_type_mode" class="form-control">
                    <option value="smiles_only">â‘  SMILES â†’ ç‰©æ€§äºˆæ¸¬</option>
                    <option value="tabular_only">â‘¡ è¡¨ãƒ‡ãƒ¼ã‚¿ â†’ ç‰¹æ€§äºˆæ¸¬</option>
                    <option value="mixture">â‘¢ æ··åˆç‰©ï¼ˆSMILESï¼‹å‰²åˆï¼‰ â†’ ç‰©æ€§äºˆæ¸¬</option>
                    <option value="smiles_tabular">â‘£ SMILESï¼‹è¡¨ãƒ‡ãƒ¼ã‚¿ â†’ ç‰©æ€§äºˆæ¸¬</option>
                </select>
            </div>
            
            <div class="grid grid-2">
                <div class="form-group">
                    <label class="form-label">ãƒ¢ãƒ‡ãƒ«</label>
                    <select name="model_type" class="form-control">
                        <option value="lightgbm">LightGBM</option>
                        <option value="xgboost">XGBoost</option>
                        <option value="random_forest">Random Forest</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">CVåˆ†å‰²æ•°</label>
                    <input type="number" name="cv_folds" class="form-control" value="5" min="2" max="10">
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">ç›®çš„ç‰©æ€§</label>
                <select name="target_property" class="form-control">
                    <option value="general">æ±ç”¨</option>
                    <option value="glass_transition">ã‚¬ãƒ©ã‚¹è»¢ç§»æ¸©åº¦(Tg)</option>
                    <option value="elastic_modulus">å¼¾æ€§ç‡</option>
                    <option value="refractive_index">å±ˆæŠ˜ç‡</option>
                    <option value="solubility">æº¶è§£åº¦ãƒ»LogP</option>
                    <option value="thermal_conductivity">ç†±ä¼å°ç‡</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">ç‰¹å¾´é‡ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                    <label style="display: flex; align-items: center; gap: 0.25rem;">
                        <input type="checkbox" name="features" value="rdkit" checked> RDKit
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.25rem;">
                        <input type="checkbox" name="features" value="xtb"> XTB
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.25rem;">
                        <input type="checkbox" name="features" value="uma"> UMA
                    </label>
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary" style="width: 100%;">
                ğŸš€ å®Ÿé¨“é–‹å§‹
            </button>
        </form>
    `);
    }

    // å®Ÿé¨“ä½œæˆå‡¦ç†
    async function handleCreateExperiment(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);

        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã® features ã‚’é…åˆ—ã«å¤‰æ›
        const features = Array.from(form.querySelectorAll('input[name="features"]:checked'))
            .map(cb => cb.value);

        const payload = {
            name: formData.get('name'),
            dataset_id: parseInt(formData.get('dataset_id')),
            task_type_mode: formData.get('task_type_mode'),
            model_type: formData.get('model_type'),
            cv_folds: parseInt(formData.get('cv_folds')),
            target_property: formData.get('target_property'),
            features,
            task_type: 'regression'
        };

        try {
            await apiCallWithCSRF('/experiments', {
                method: 'POST',
                body: JSON.stringify(payload)
            });

            showToast('å®Ÿé¨“ã‚’é–‹å§‹ã—ã¾ã—ãŸï¼', 'success');
            document.querySelector('.modal-overlay').remove();
            experimentsTable.render();
        } catch (e) {
            // Error handled
        }
    }

    // å®Ÿé¨“è©³ç´°è¡¨ç¤º
    async function viewExperiment(id) {
        const modal = new ModalDialog();
        modal.show('å®Ÿé¨“è©³ç´°', '<div class="spinner" style="margin: 2rem auto;"></div>');

        try {
            const exp = await apiCall(`/experiments/${id}`);

            let content = `
            <div class="grid grid-2" style="margin-bottom: 1rem;">
                <div>
                    <h4>åŸºæœ¬æƒ…å ±</h4>
                    <table class="table" style="font-size: 0.9rem;">
                        <tr><th>ID</th><td>${exp.id}</td></tr>
                        <tr><th>åå‰</th><td>${exp.name}</td></tr>
                        <tr><th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th><td><span class="badge badge-${exp.status === 'COMPLETED' ? 'success' : exp.status === 'RUNNING' ? 'warning' : 'error'}">${exp.status}</span></td></tr>
                        <tr><th>ãƒ¢ãƒ‡ãƒ«</th><td>${exp.config?.model_type}</td></tr>
                        <tr><th>ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—</th><td>${exp.config?.task_type_mode}</td></tr>
                    </table>
                </div>
                <div>
                    <h4>ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿</h4>
                    <table class="table" style="font-size: 0.9rem;">
                        <tr><th>CVåˆ†å‰²</th><td>${exp.config?.cv_folds}</td></tr>
                        <tr><th>ç‰©æ€§</th><td>${exp.config?.target_property}</td></tr>
                        <tr><th>ç‰¹å¾´é‡</th><td>${exp.config?.features?.join(', ')}</td></tr>
                    </table>
                </div>
            </div>
        `;

            if (exp.metrics && exp.status === 'COMPLETED') {
                content += `
                <h4>ãƒ¡ãƒˆãƒªã‚¯ã‚¹</h4>
                <div class="grid grid-3" style="margin-bottom: 1rem;">
            `;

                for (const [key, value] of Object.entries(exp.metrics)) {
                    if (typeof value === 'number') {
                        content += `
                        <div style="background: var(--bg-hover); padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary);">${value.toFixed(4)}</div>
                            <div style="font-size: 0.875rem; color: var(--text-muted);">${key.toUpperCase()}</div>
                        </div>
                    `;
                    }
                }

                content += '</div>';
            }

            document.querySelector('.modal-content div:last-child').innerHTML = content;
        } catch (e) {
            document.querySelector('.modal-content div:last-child').innerHTML =
                '<p style="color: var(--error);">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</p>';
        }
    }

    // ãƒ¢ãƒ‡ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    function downloadModel(id) {
        window.location.href = `${API_URL}/experiments/${id}/download`;
    }
</script>
{% endblock %}